apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "xerv.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "xerv.labels" . | nindent 4 }}
data:
  config.yaml: |
    # XERV Cluster Configuration
    # Generated by Helm

    cluster:
      name: {{ include "xerv.fullname" . }}
      namespace: {{ .Release.Namespace }}

    server:
      api_port: {{ .Values.server.apiPort }}
      grpc_port: {{ .Values.server.grpcPort }}
      data_dir: /data

    dispatch:
      backend: {{ .Values.dispatch.backend }}
      {{- if eq .Values.dispatch.backend "redis" }}
      redis:
        url: {{ .Values.dispatch.redis.url | quote }}
        use_streams: {{ .Values.dispatch.redis.useStreams }}
        pool_size: {{ .Values.dispatch.redis.poolSize }}
        consumer_group: {{ .Values.dispatch.redis.consumerGroup | quote }}
      {{- end }}
      {{- if eq .Values.dispatch.backend "nats" }}
      nats:
        url: {{ .Values.dispatch.nats.url | quote }}
        use_jetstream: {{ .Values.dispatch.nats.useJetstream }}
        stream_name: {{ .Values.dispatch.nats.streamName | quote }}
      {{- end }}
      {{- if eq .Values.dispatch.backend "raft" }}
      raft:
        election_timeout_ms: {{ .Values.dispatch.raft.electionTimeoutMs }}
        heartbeat_interval_ms: {{ .Values.dispatch.raft.heartbeatIntervalMs }}
        peers_file: /config/peers.yaml
      {{- end }}

    {{- if .Values.metrics.enabled }}
    metrics:
      enabled: true
      port: {{ .Values.metrics.port }}
      path: {{ .Values.metrics.path }}
    {{- end }}

  {{- if eq .Values.dispatch.backend "raft" }}
  peers.yaml: |
    # Raft Cluster Peers
    # Auto-generated by Helm
    peers:
    {{- $fullname := include "xerv.fullname" . }}
    {{- $headless := include "xerv.headlessServiceName" . }}
    {{- $namespace := .Release.Namespace }}
    {{- $grpcPort := .Values.server.grpcPort }}
    {{- range $i := until (int .Values.replicaCount) }}
      - node_id: {{ add $i 1 }}
        address: {{ $fullname }}-{{ $i }}.{{ $headless }}.{{ $namespace }}.svc.cluster.local:{{ $grpcPort }}
    {{- end }}
  {{- end }}
