# XERV Custom Resource Definitions
# Generated from xerv-operator CRD types.
# To regenerate: cargo run --bin xerv-operator -- --generate-crds
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: xervclusters.xerv.io
spec:
  group: xerv.io
  names:
    kind: XervCluster
    listKind: XervClusterList
    plural: xervclusters
    shortNames:
      - xc
    singular: xervcluster
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              properties:
                replicas:
                  type: integer
                  format: int32
                  default: 1
                  description: Number of replicas in the cluster. For Raft, should be odd (1, 3, 5).
                dispatch:
                  type: object
                  properties:
                    backend:
                      type: string
                      default: raft
                      description: Backend type (raft, redis, nats, memory)
                    redis:
                      type: object
                      properties:
                        url:
                          type: string
                        useStreams:
                          type: boolean
                          default: true
                        poolSize:
                          type: integer
                          format: int32
                          default: 10
                        consumerGroup:
                          type: string
                          default: xerv-workers
                      required:
                        - url
                    nats:
                      type: object
                      properties:
                        url:
                          type: string
                        useJetstream:
                          type: boolean
                          default: true
                        streamName:
                          type: string
                          default: XERV_TRACES
                      required:
                        - url
                storage:
                  type: object
                  properties:
                    class:
                      type: string
                    size:
                      type: string
                      default: 10Gi
                    accessMode:
                      type: string
                      default: ReadWriteOnce
                resources:
                  type: object
                  properties:
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                        memory:
                          type: string
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                        memory:
                          type: string
                image:
                  type: string
                  default: ghcr.io/ml-rust/xerv:latest
                imagePullPolicy:
                  type: string
                  default: IfNotPresent
                serviceAccount:
                  type: string
                nodeSelector:
                  type: object
                  additionalProperties:
                    type: string
                tolerations:
                  type: array
                  items:
                    type: object
                    properties:
                      key:
                        type: string
                      operator:
                        type: string
                      value:
                        type: string
                      effect:
                        type: string
                      tolerationSeconds:
                        type: integer
                        format: int64
                metricsEnabled:
                  type: boolean
                  default: true
                apiPort:
                  type: integer
                  format: int32
                  default: 8080
                grpcPort:
                  type: integer
                  format: int32
                  default: 5000
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Initializing
                    - Running
                    - Updating
                    - Degraded
                    - Failed
                    - Terminating
                  default: Pending
                readyReplicas:
                  type: integer
                  format: int32
                  default: 0
                availableReplicas:
                  type: integer
                  format: int32
                  default: 0
                leader:
                  type: string
                endpoint:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                lastUpdated:
                  type: string
                message:
                  type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Backend
          type: string
          jsonPath: .spec.dispatch.backend
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: xervpipelines.xerv.io
spec:
  group: xerv.io
  names:
    kind: XervPipeline
    listKind: XervPipelineList
    plural: xervpipelines
    shortNames:
      - xp
    singular: xervpipeline
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - cluster
                - source
              properties:
                cluster:
                  type: string
                  description: Name of the XervCluster to deploy to
                source:
                  type: object
                  oneOf:
                    - properties:
                        configMap:
                          type: object
                          required:
                            - name
                          properties:
                            name:
                              type: string
                            key:
                              type: string
                              default: pipeline.yaml
                      required:
                        - configMap
                    - properties:
                        git:
                          type: object
                          required:
                            - repo
                            - path
                          properties:
                            repo:
                              type: string
                            refName:
                              type: string
                              default: main
                            path:
                              type: string
                            credentialsSecret:
                              type: string
                            syncInterval:
                              type: string
                              default: 5m
                      required:
                        - git
                    - properties:
                        inline:
                          type: object
                          required:
                            - content
                          properties:
                            content:
                              type: string
                      required:
                        - inline
                triggers:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - name
                    properties:
                      type:
                        type: string
                        enum:
                          - webhook
                          - cron
                          - manual
                      name:
                        type: string
                      webhook:
                        type: object
                        required:
                          - path
                        properties:
                          path:
                            type: string
                          methods:
                            type: array
                            items:
                              type: string
                            default:
                              - POST
                          auth:
                            type: object
                            required:
                              - type
                              - secret
                            properties:
                              type:
                                type: string
                              secret:
                                type: string
                              key:
                                type: string
                                default: token
                      cron:
                        type: object
                        required:
                          - schedule
                        properties:
                          schedule:
                            type: string
                          timezone:
                            type: string
                            default: UTC
                          catchUp:
                            type: boolean
                            default: false
                          concurrencyPolicy:
                            type: string
                            default: Forbid
                      manual:
                        type: object
                        properties:
                          description:
                            type: string
                          parameters:
                            type: array
                            items:
                              type: object
                              required:
                                - name
                              properties:
                                name:
                                  type: string
                                type:
                                  type: string
                                  default: string
                                required:
                                  type: boolean
                                  default: false
                                default:
                                  x-kubernetes-preserve-unknown-fields: true
                                description:
                                  type: string
                paused:
                  type: boolean
                  default: false
                env:
                  type: object
                  additionalProperties:
                    type: string
                secrets:
                  type: array
                  items:
                    type: object
                    required:
                      - name
                      - key
                      - envVar
                    properties:
                      name:
                        type: string
                      key:
                        type: string
                      envVar:
                        type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Validating
                    - Active
                    - Paused
                    - Error
                    - Terminating
                  default: Pending
                activeTriggers:
                  type: integer
                  format: int32
                  default: 0
                totalTraces:
                  type: integer
                  format: int64
                  default: 0
                successfulTraces:
                  type: integer
                  format: int64
                  default: 0
                failedTraces:
                  type: integer
                  format: int64
                  default: 0
                lastSuccessTime:
                  type: string
                lastFailureTime:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                lastUpdated:
                  type: string
                message:
                  type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Cluster
          type: string
          jsonPath: .spec.cluster
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Triggers
          type: integer
          jsonPath: .status.activeTriggers
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
