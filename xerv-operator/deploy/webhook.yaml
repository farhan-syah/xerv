# ValidatingWebhookConfiguration for XERV Operator Secret Access Control
#
# This webhook validates that the XERV operator only accesses secrets
# that are explicitly labeled for XERV management.
#
# Prerequisites:
# 1. cert-manager installed in the cluster
# 2. Certificate created for the webhook server
# 3. Webhook server deployed (see webhook-server.yaml)
---
apiVersion: v1
kind: Service
metadata:
  name: xerv-operator-webhook
  namespace: xerv-system
  labels:
    app.kubernetes.io/name: xerv-operator-webhook
    app.kubernetes.io/component: webhook
spec:
  selector:
    app.kubernetes.io/name: xerv-operator-webhook
  ports:
    - name: https
      port: 443
      targetPort: 8443
      protocol: TCP

---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: xerv-operator-secret-validator
  labels:
    app.kubernetes.io/name: xerv-operator
    app.kubernetes.io/component: webhook
  annotations:
    cert-manager.io/inject-ca-from: xerv-system/xerv-operator-webhook-cert
webhooks:
  - name: validate-secret-access.xerv.io
    admissionReviewVersions: ["v1", "v1beta1"]
    clientConfig:
      service:
        name: xerv-operator-webhook
        namespace: xerv-system
        path: /validate/secret
        port: 443
    rules:
      - operations: ["GET", "LIST", "WATCH"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["secrets"]
        scope: "Namespaced"
    failurePolicy: Ignore  # Don't block if webhook is unavailable
    sideEffects: None
    timeoutSeconds: 5
    namespaceSelector:
      matchLabels:
        xerv.io/operator-managed: "true"
    objectSelector:
      matchExpressions:
        # Only allow access to secrets with XERV labels
        - key: app.kubernetes.io/managed-by
          operator: In
          values: ["xerv", "xerv-operator"]

---
# Certificate for webhook TLS
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: xerv-operator-webhook-cert
  namespace: xerv-system
spec:
  secretName: xerv-operator-webhook-tls
  duration: 2160h # 90 days
  renewBefore: 360h # 15 days
  subject:
    organizations:
      - xerv-system
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
    - client auth
  dnsNames:
    - xerv-operator-webhook
    - xerv-operator-webhook.xerv-system
    - xerv-operator-webhook.xerv-system.svc
    - xerv-operator-webhook.xerv-system.svc.cluster.local
  issuerRef:
    name: selfsigned-issuer
    kind: Issuer
    group: cert-manager.io

---
# Self-signed issuer for development
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
  namespace: xerv-system
spec:
  selfSigned: {}

---
# Webhook server deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: xerv-operator-webhook
  namespace: xerv-system
  labels:
    app.kubernetes.io/name: xerv-operator-webhook
    app.kubernetes.io/component: webhook
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: xerv-operator-webhook
  template:
    metadata:
      labels:
        app.kubernetes.io/name: xerv-operator-webhook
    spec:
      serviceAccountName: xerv-operator
      containers:
        - name: webhook
          image: xerv-operator:latest  # Replace with actual image
          command:
            - /usr/local/bin/xerv-operator-webhook
          ports:
            - name: https
              containerPort: 8443
              protocol: TCP
            - name: metrics
              containerPort: 8080
              protocol: TCP
          env:
            - name: TLS_CERT_FILE
              value: /certs/tls.crt
            - name: TLS_KEY_FILE
              value: /certs/tls.key
            - name: WEBHOOK_PORT
              value: "8443"
          volumeMounts:
            - name: webhook-certs
              mountPath: /certs
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 65532
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: webhook-certs
          secret:
            secretName: xerv-operator-webhook-tls
            defaultMode: 0400

---
# NetworkPolicy to restrict webhook access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: xerv-operator-webhook
  namespace: xerv-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: xerv-operator-webhook
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from kube-apiserver
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
        - podSelector:
            matchLabels:
              component: kube-apiserver
      ports:
        - protocol: TCP
          port: 8443
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow Kubernetes API access
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: TCP
          port: 443
